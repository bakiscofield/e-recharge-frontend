<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Service Worker - AliceBot</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #3B82F6;
            margin-top: 0;
        }
        button {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #2563EB;
        }
        .danger {
            background: #EF4444;
        }
        .danger:hover {
            background: #DC2626;
        }
        .success {
            background: #10B981;
        }
        pre {
            background: #1F2937;
            color: #10B981;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background: #FEF3C7;
            border-left: 4px solid #F59E0B;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>üîß Reset Service Worker</h1>
        <p>Utilisez cette page pour r√©soudre les probl√®mes de service worker et notifications.</p>

        <div class="status" id="status">
            Status: V√©rification en cours...
        </div>

        <h3>Actions disponibles :</h3>

        <button onclick="checkStatus()">üîç V√©rifier le statut</button>
        <button onclick="unregisterAll()" class="danger">üóëÔ∏è D√©sinstaller tous les SW</button>
        <button onclick="clearCaches()" class="danger">üßπ Vider tous les caches</button>
        <button onclick="resetAll()" class="danger">‚ôªÔ∏è Reset complet</button>
        <button onclick="goBack()" class="success">‚úÖ Retour √† l'app</button>

        <h3>Console :</h3>
        <pre id="console"></pre>
    </div>

    <script>
        const consoleEl = document.getElementById('console');
        const statusEl = document.getElementById('status');

        function log(message) {
            const time = new Date().toLocaleTimeString();
            consoleEl.textContent += `[${time}] ${message}\n`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.style.background = type === 'success' ? '#D1FAE5' :
                                       type === 'error' ? '#FEE2E2' : '#FEF3C7';
            statusEl.style.borderLeftColor = type === 'success' ? '#10B981' :
                                            type === 'error' ? '#EF4444' : '#F59E0B';
        }

        async function checkStatus() {
            log('üîç V√©rification du statut...');

            // Service Workers
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                log(`üìã Service Workers enregistr√©s: ${registrations.length}`);
                registrations.forEach((reg, index) => {
                    log(`  ${index + 1}. Scope: ${reg.scope}`);
                    log(`     State: ${reg.active?.state || 'N/A'}`);
                    log(`     URL: ${reg.active?.scriptURL || 'N/A'}`);
                });

                if (navigator.serviceWorker.controller) {
                    log(`‚úÖ Service Worker actif: ${navigator.serviceWorker.controller.scriptURL}`);
                } else {
                    log(`‚ö†Ô∏è Aucun Service Worker en contr√¥le`);
                }
            } else {
                log('‚ùå Service Workers non support√©s');
            }

            // Notifications
            if ('Notification' in window) {
                log(`üîî Permission notifications: ${Notification.permission}`);
            }

            // Caches
            const cacheNames = await caches.keys();
            log(`üíæ Caches: ${cacheNames.length}`);
            cacheNames.forEach(name => log(`  - ${name}`));

            // localStorage
            log(`üì¶ localStorage items: ${Object.keys(localStorage).length}`);

            updateStatus(`‚úÖ V√©rification termin√©e - ${registrations?.length || 0} SW trouv√©s`, 'success');
        }

        async function unregisterAll() {
            if (!confirm('D√©sinstaller tous les service workers ?')) return;

            log('üóëÔ∏è D√©sinstallation de tous les service workers...');

            const registrations = await navigator.serviceWorker.getRegistrations();
            let count = 0;

            for (const registration of registrations) {
                log(`  D√©sinstallation: ${registration.scope}`);
                await registration.unregister();
                count++;
            }

            log(`‚úÖ ${count} service worker(s) d√©sinstall√©(s)`);
            updateStatus(`‚úÖ ${count} service worker(s) d√©sinstall√©(s)`, 'success');
        }

        async function clearCaches() {
            if (!confirm('Vider tous les caches ?')) return;

            log('üßπ Vidage de tous les caches...');

            const cacheNames = await caches.keys();
            let count = 0;

            for (const cacheName of cacheNames) {
                log(`  Suppression: ${cacheName}`);
                await caches.delete(cacheName);
                count++;
            }

            log(`‚úÖ ${count} cache(s) supprim√©(s)`);
            updateStatus(`‚úÖ ${count} cache(s) supprim√©(s)`, 'success');
        }

        async function resetAll() {
            if (!confirm('‚ö†Ô∏è RESET COMPLET ?\n\nCela va :\n- D√©sinstaller tous les SW\n- Vider tous les caches\n- Vider le localStorage\n\nContinuer ?')) {
                return;
            }

            log('‚ôªÔ∏è RESET COMPLET en cours...');

            // 1. D√©sinstaller SW
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (const reg of registrations) {
                await reg.unregister();
                log(`  ‚úÖ SW d√©sinstall√©: ${reg.scope}`);
            }

            // 2. Vider caches
            const cacheNames = await caches.keys();
            for (const cacheName of cacheNames) {
                await caches.delete(cacheName);
                log(`  ‚úÖ Cache supprim√©: ${cacheName}`);
            }

            // 3. Vider localStorage
            const itemsCount = Object.keys(localStorage).length;
            localStorage.clear();
            log(`  ‚úÖ localStorage vid√© (${itemsCount} items)`);

            log('');
            log('‚úÖ RESET COMPLET TERMIN√â !');
            log('üîÑ Rechargement de la page dans 3 secondes...');

            updateStatus('‚úÖ Reset complet termin√© ! Rechargement...', 'success');

            setTimeout(() => {
                window.location.href = '/';
            }, 3000);
        }

        function goBack() {
            window.location.href = '/';
        }

        // V√©rifier automatiquement au chargement
        window.addEventListener('load', checkStatus);
    </script>
</body>
</html>
